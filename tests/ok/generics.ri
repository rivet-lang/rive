fn size_of<T>() usize { return size_of!(T); }

unsafe fn new<T>() *mut T {
    return unsafe {
        as(*mut T, mem::alloc(size_of::<T>()) catch none)
    };
}

unsafe fn delete<T>(obj: *mut T) {
    unsafe {
        if (obj != none) {
            mem::dealloc(obj);
        }
    }
}

fn triple<A, B, C>(a: A, b: B, c: C) (A, B, C) {
    return (a, b, c);
}

fn eq<T>(a: T, b: T) bool {
    return a == b;
}

fn ne<T>(a: T, b: T) bool {
    return a != b;
}

struct Generic<T> {
    mut a: T;

    fn value(self) T {
        return self.a;
    }

    fn set_value(&mut self, a: T) {
        self.a = a;
    }
}

fn main() {
    assert!(size_of::<i8>() == 1);
    assert!(size_of::<i32>() == 4);
    assert!(size_of::<rune>() == 4);

    unsafe {
        // --- i32 ---
        let u = new::<i32>();
        assert!(u != none);
        delete::<i32>(u);

        // --- str ---
        let v = new::<str>();
        assert!(v != none);
        delete::<str>(v);
    }

    let t = triple::<i32, bool, str>(5, true, "empty");
    assert!(t.0 == 5 and t.1 and t.2 == "empty");

    assert!(eq::<u8>(2, 2));
    assert!(eq::<i32>(2, 2));
    assert!(eq::<str>("2", "2"));
    assert!(eq::<String>("2".to_string(), "2".to_string()));

    assert!(ne::<u8>(1, 2));
    assert!(ne::<i32>(1, 2));
    assert!(ne::<str>("1", "2"));
    assert!(ne::<String>("1".to_string(), "2".to_string()));

    // generic insts
    assert!(Generic::<u8>{ a: 2 }.a == 2);
    assert!(Generic::<i32>{ a: 5 }.a == 5);
    assert!(Generic::<str>{ a: "Abc" }.a == "Abc");

    // generic methods
    assert!(Generic::<i8>{ a: 2 }.value() == 2);
    assert!(Generic::<i64>{ a: 5 }.value() == 5);
    assert!(Generic::<str>{ a: "Abc" }.value() == "Abc");
    assert!(Generic::<bool>{ a: false }.value() == false);

    let mut x = Generic::<i64>{
        a: 1
    };
    assert!(x.a == 1);
    x.set_value(5);
    assert!(x.a == 5);

    unsafe {
        let mut res = new::<Generic<i8>>();
        assert!(res != none);
        res.a = 1;
        assert!(res.a == 1);
        delete::<Generic<i8>>(res);
    }
}
